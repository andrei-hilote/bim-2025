
    <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shapefile Loader</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
     <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #fff;
            color: #333;
            font-family: 'Arial', sans-serif;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            text-align: center;
            z-index: 2;
            padding: 2rem;
            background: transparent;
            transition: transform 0.3s ease;
            position: relative;
        }

        .title {
            font-size: 4rem;
            margin-bottom: 1rem;
            min-height: 4rem;
            cursor: default;
            color: #333;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 1s ease forwards;
        }

        .title span {
            display: inline-block;
            opacity: 0;
            transform: translateY(20px);
        }

        .subtitle {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            opacity: 0;
            animation: fadeIn 1s ease-in forwards;
            animation-delay: 1s;
        }

        /* Analysis Button */
        .analysis-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 24px;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .analysis-button:hover {
            background: #34495e;
            transform: translateY(-2px);
        }

        .analysis-button.active {
            background: #e74c3c;
        }

        /* Enhanced Popup Styling */
        .custom-popup {
            max-width: 400px !important;
            max-height: 500px !important;
        }

        .popup-content {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #888 #f1f1f1;
        }

        .popup-content::-webkit-scrollbar {
            width: 8px;
        }

        .popup-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .popup-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .popup-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .risk-level {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .risk-level.high { background: #ff6b6b; color: white; }
        .risk-level.medium { background: #ffd93d; color: black; }
        .risk-level.low { background: #6dd5ab; color: white; }

        .popup-list {
            margin: 10px 0;
            padding-left: 20px;
        }

        .popup-list li {
            margin: 5px 0;
            line-height: 1.4;
            color: #555;
        }

        /* Ripple Effect */
        .ripple {
            pointer-events: none;
            position: absolute;
            background: rgba(255, 0, 0, 0.4); /* Red background */
            border: 2px solid rgba(255, 0, 0, 0.8); /* Red border */
            border-radius: 50%;
            animation: rippleEffect 2s ease-out infinite;
            z-index: 1000;
        }

        @keyframes rippleEffect {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .weather-section {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .weather-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .weather-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

.flood-risk-popup-container .leaflet-popup-content-wrapper {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(5px);
}

.flood-risk-popup {
    min-width: 300px;
    padding: 10px;
}

.popup-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid rgba(0, 0, 0, 0.1);
}

.risk-icon {
    font-size: 24px;
}

.popup-header h3 {
    margin: 0;
    color: #2c3e50;
    font-size: 1.4em;
}

.risk-stats {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
}

.stat-box {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(255, 255, 255, 0.9);
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
}

.stat-icon {
    font-size: 20px;
}

.stat-content {
    flex: 1;
}

.stat-value {
    font-size: 1.2em;
    font-weight: bold;
    color: #2c3e50;
}

.stat-label {
    font-size: 0.8em;
    color: #666;
}

.risk-details {
    background: rgba(245, 245, 245, 0.9);
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
}

.risk-details h4 {
    margin: 0 0 10px 0;
    color: #2c3e50;
}

.details-grid {
    display: grid;
    gap: 10px;
}

.detail-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.detail-label {
    color: #666;
}

.detail-value {
    font-weight: 500;
}

.severity-high, .risk-critical {
    color: #e74c3c;
    font-weight: bold;
}

.popup-footer {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.action-button {
    flex: 1;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    background: #3498db;
    color: white;
    cursor: pointer;
    font-size: 0.9em;
    transition: all 0.3s ease;
}

.action-button:hover {
    background: #2980b9;
    transform: translateY(-1px);
}

body {
    background-color: #fff;
    color: #333;
    font-family: 'Arial', sans-serif;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
}

.container {
    text-align: center;
    z-index: 2;
    padding: 2rem;
    background: transparent;
    transition: transform 0.3s ease;
    position: relative;
}

.container:hover {
    transform: scale(1.02);
}

.title {
    font-size: 4rem;
    margin-bottom: 1rem;
    min-height: 4rem;
    cursor: default;
    color: #333;
}

.title span {
    display: inline-block;
    transition: transform 0.3s ease, color 0.3s ease;
}

.title span:hover {
    transform: translateY(-5px);
    color: #0066cc;
}

.subtitle {
    font-size: 1.2rem;
    margin-bottom: 2rem;
    opacity: 0;
    animation: fadeIn 1s ease-in forwards;
    animation-delay: 3s;
}

.loading-bar {
    width: 300px;
    height: 4px;
    background: rgba(0, 0, 0, 0.1);
    margin: 2rem auto;
    position: relative;
    overflow: hidden;
}

.progress {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 0;
    background: #0066cc;
    animation: progress 3s ease-in-out infinite;
}

.loading-text {
    font-size: 0.8rem;
    letter-spacing: 0.2em;
    animation: blink 1s infinite;
    color: #666;
}

/* Remove all globe-related CSS */
.globe {
    display: none;
}

.globe::before {
    display: none;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes blink {
    50% { opacity: 0.5; }
}

@keyframes progress {
    0% { width: 0; }
    50% { width: 100%; }
    100% { width: 0; }
}

#particles-js {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
    opacity: 0.5;
}

.cursor-trail {
    position: fixed;
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: rgba(128, 128, 128, 0.5);
    pointer-events: none;
    z-index: 3;
    animation: cursorFade 1s ease-out forwards;
}

@keyframes cursorFade {
    0% {
        opacity: 1;
        transform: scale(1);
    }
    100% {
        opacity: 0;
        transform: scale(0);
    }
}

#globe-container {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 0;
    opacity: 0.3;
    pointer-events: none;
}

#particles-js {
    z-index: 1;
}

.container {
    position: relative;
    z-index: 2;
}
#filter-container {
            position: absolute;
            top: 20px;
            right: 20px;



    width: 250px;

            z-index: 1000;
        }



.filter-checkbox {
    margin: 12px 0;
    padding: 8px 12px;
    border-radius: 8px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    cursor: pointer;
    background: rgba(255, 255, 255, 0.7);
}

.filter-checkbox:hover {
    background: rgba(43, 108, 176, 0.1);
    transform: translateX(5px);
}

.filter-checkbox input[type="checkbox"] {
    appearance: none;
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border: 2px solid #2b6cb0;
    border-radius: 6px;
    margin-right: 12px;
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease;
}

.filter-checkbox input[type="checkbox"]:checked {
    background-color: #2b6cb0;
    border-color: #2b6cb0;
}

.filter-checkbox input[type="checkbox"]:checked::after {
    content: '✓';
    position: absolute;
    color: white;
    font-size: 14px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.filter-checkbox input[type="checkbox"]:hover {
    border-color: #4299e1;
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
}

.filter-checkbox label {
    font-size: 0.95em;
    color: #4a5568;
    cursor: pointer;
    user-select: none;
    transition: color 0.2s ease;
    flex-grow: 1;
}

.filter-checkbox:hover label {
    color: #2b6cb0;
}

/* Water type specific icons */
.filter-checkbox label::before {
    font-family: Arial, sans-serif;
    margin-right: 8px;
    color: #2b6cb0;
    font-size: 16px;
}

.filter-checkbox input[value="river"] + label::before {
    content: '🌊';
}

.filter-checkbox input[value="stream"] + label::before {
    content: '💧';
}

.filter-checkbox input[value="canal"] + label::before {
    content: '⛵';
}

.filter-checkbox input[value="drain"] + label::before {
    content: '🌧️';
}

.filter-checkbox input[value="ditch"] + label::before {
    content: '➡️';
}

.filter-checkbox input[value="other"] + label::before {
    content: '❔';
}

/* Animation for checkbox checking */
.filter-checkbox input[type="checkbox"]:checked {
    animation: checkmark 0.2s ease-in-out;
}

@keyframes checkmark {
    0% {
        transform: scale(0.8);
    }
    50% {
        transform: scale(1.1);
    }
    100% {
        transform: scale(1);
    }
}

/* Container entrance animation */
#filter-container {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    #filter-container {
        width: 100%;
        max-width: 250px;
        margin: 0 auto;
    }

    .filter-checkbox {
        padding: 10px;
    }
}


       #control-panel {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    padding: 10px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(5px);
}

/* Flood Zone Base Styles */
.flood-zone {
    transition: all 0.3s ease-in-out;
    animation: fadeIn 0.5s ease-out forwards;
}

.flood-zone-appear {
    animation: zoneAppear 0.8s ease-out forwards;
}

/* Risk Level Specific Styles */
.flood-zone-high {
    animation: pulseHigh 2s infinite;
}

.flood-zone-medium {
    animation: pulseMedium 2.5s infinite;
}

.flood-zone-low {
    animation: pulseLow 3s infinite;
}

/* Hover Effects */
.flood-zone-hover {
    filter: brightness(1.2);
    transform: scale(1.01);
}


/* Legend Styles */
.animated-legend {
    background: rgba(255, 255, 255, 0.9);
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.legend-item {
    display: flex;
    align-items: center;
    margin: 5px 0;
    opacity: 0;
    animation: slideIn 0.5s ease-out forwards;
}

.color-box {
    width: 20px;
    height: 20px;
    margin-right: 8px;
    border-radius: 4px;
    position: relative;
}

.pulse-ring {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 4px;
    animation: pulseRing 2s infinite;
}

/* Popup Styles */
.flood-zone-popup {
    padding: 15px;
    border-radius: 8px;
    animation: popupAppear 0.3s ease-out;
}

.risk-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
    display: inline-block;
}

.depth-meter {
    margin-top: 10px;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 4px;
    overflow: hidden;
}

.depth-bar {
    height: 20px;
    background: linear-gradient(90deg, #64b5f6, #1976d2);
    transition: width 1s ease-out;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes zoneAppear {
    0% {
        opacity: 0;
        transform: translateY(20px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulseHigh {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.3); }
    100% { filter: brightness(1); }
}

@keyframes pulseMedium {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.2); }
    100% { filter: brightness(1); }
}

@keyframes pulseLow {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.1); }
    100% { filter: brightness(1); }
}



@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes pulseRing {
    0% {
        transform: scale(1);
        opacity: 0.8;
    }
    50% {
        transform: scale(1.2);
        opacity: 0.4;
    }
    100% {
        transform: scale(1);
        opacity: 0.8;
    }
}

@keyframes popupAppear {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

/* Fade out animation */
.fade-out {
    animation: fadeOut 0.5s ease-out forwards;
}

@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

/* Pulse text animation for legend title */
.pulse-text {
    animation: pulseText 2s infinite;
}

@keyframes pulseText {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.button-group {
    display: flex;
    gap: 10px;
}

.control-button {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: #ffffff;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 15px;
    font-weight: 500;
    color: #333;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}

.control-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    border-color: #2c3e50;
}

.control-button .button-icon {
    font-size: 18px;
}

.control-button .button-text {
    white-space: nowrap;
}

/* Active States */
#analysisButton.active {
    background: #2c3e50;
    color: white;
    border-color: #2c3e50;
}

#inundationButton.active {
    background: #e74c3c;
    color: white;
    border-color: #e74c3c;
}

/* Disabled State */
.control-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* Loading State */
.control-button.loading {
    position: relative;
    overflow: hidden;
}

.control-button.loading::after {
    content: '';
    position: absolute;
    left: -100%;
    top: 0;
    height: 2px;
    width: 100%;
    background: linear-gradient(90deg, transparent, #fff, transparent);
    animation: loading 1.5s infinite;
}

@keyframes loading {
    from { left: -100%; }
    to { left: 100%; }
}

/* Hover Effects */
.control-button:hover .button-icon {
    transform: scale(1.1);
}

/* Flood Zone Base Styles */
.flood-zone {
    transition: all 0.3s ease-in-out;
    animation: fadeIn 0.5s ease-out forwards;
}

.flood-zone-appear {
    animation: zoneAppear 0.8s ease-out forwards;
}

/* Risk Level Specific Styles */
.flood-zone-high {
    animation: pulseHigh 2s infinite;
}

.flood-zone-medium {
    animation: pulseMedium 2.5s infinite;
}

.flood-zone-low {
    animation: pulseLow 3s infinite;
}

/* Hover Effects */
.flood-zone-hover {
    filter: brightness(1.2);
    transform: scale(1.01);
}



/* Legend Styles */
.animated-legend {
    background: rgba(255, 255, 255, 0.9);
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.legend-item {
    display: flex;
    align-items: center;
    margin: 5px 0;
    opacity: 0;
    animation: slideIn 0.5s ease-out forwards;
}

.color-box {
    width: 20px;
    height: 20px;
    margin-right: 8px;
    border-radius: 4px;
    position: relative;
}

.pulse-ring {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 4px;
    animation: pulseRing 2s infinite;
}

/* Popup Styles */
.flood-zone-popup {
    padding: 15px;
    border-radius: 8px;
    animation: popupAppear 0.3s ease-out;
}

.risk-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
    display: inline-block;
}

.depth-meter {
    margin-top: 10px;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 4px;
    overflow: hidden;
}

.depth-bar {
    height: 20px;
    background: linear-gradient(90deg, #64b5f6, #1976d2);
    transition: width 1s ease-out;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes zoneAppear {
    0% {
        opacity: 0;
        transform: translateY(20px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulseHigh {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.3); }
    100% { filter: brightness(1); }
}

@keyframes pulseMedium {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.2); }
    100% { filter: brightness(1); }
}

@keyframes pulseLow {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.1); }
    100% { filter: brightness(1); }
}



@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes pulseRing {
    0% {
        transform: scale(1);
        opacity: 0.8;
    }
    50% {
        transform: scale(1.2);
        opacity: 0.4;
    }
    100% {
        transform: scale(1);
        opacity: 0.8;
    }
}

@keyframes popupAppear {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

/* Fade out animation */
.fade-out {
    animation: fadeOut 0.5s ease-out forwards;
}

@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

/* Pulse text animation for legend title */
.pulse-text {
    animation: pulseText 2s infinite;
}

@keyframes pulseText {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* Responsive Design */
@media (max-width: 768px) {
    #control-panel {
        bottom: 10px;
        right: 10px;
        left: 10px;
    }

    .button-group {
        justify-content: space-around;
    }

    .control-button {
        padding: 10px 15px;
        font-size: 14px;
    }

      .inundation-polygon {
        fill: url(#water-pattern) #3498db;
        transition: all 0.3s ease;
        animation: waterFlow 3s infinite linear;
    }

    .inundation-polygon:hover {
        filter: brightness(1.2);
    }

    /* Water Pattern Animation */
    @keyframes waterFlow {
        0% {
            stroke-dashoffset: 0;
        }
        100% {
            stroke-dashoffset: 100;
        }
    }

    /* Loading Animation */
    .loading-overlay {
        position: absolute;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1001;
        border-radius: 8px;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* QR Code Container */
.qr-container {
    position: fixed;
    bottom: 40px;
    left: 40px;
    background: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    z-index: 1000;
    width: 200px;
    transition: all 0.3s ease;
    border: 1px solid rgba(0, 0, 0, 0.1);
}

/* Header */
.qr-header {
    text-align: center;
    margin-bottom: 15px;
}

.qr-title {
    font-size: 1.2em;
    color: #2c3e50;
    margin: 0;
    font-weight: 600;
}

.qr-subtitle {
    font-size: 0.9em;
    color: #7f8c8d;
    margin: 5px 0 0;
}

/* QR Code Wrapper */
.qr-code-wrapper {
    background: white;
    padding: 10px;
    border-radius: 10px;
    box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
    margin: 10px 0;
}

/* QR Code Image */
.qr-code {
    width: 100%;
    height: auto;
    display: block;
}

/* Scan Instructions */
.scan-instructions {
    text-align: center;
    font-size: 0.85em;
    color: #34495e;
    margin-top: 15px;
    padding: 10px;
    background: rgba(52, 152, 219, 0.1);
    border-radius: 8px;
}

/* Minimize Button */
.minimize-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    color: #95a5a6;
    cursor: pointer;
    padding: 5px;
    font-size: 1.2em;
    transition: color 0.3s ease;
}

.minimize-btn:hover {
    color: #2c3e50;
}

/* Minimized State */
.qr-container.minimized {
    width: 50px;
    height: 50px;
    padding: 10px;
    cursor: pointer;
}

.qr-container.minimized .qr-content {
    display: none;
}

.qr-container.minimized .minimize-btn {
    display: none;
}

/* Expand Button (shown when minimized) */
.expand-btn {
    display: none;
    width: 100%;
    height: 100%;
    background: none;
    border: none;
    color: #2c3e50;
    cursor: pointer;
}

.qr-container.minimized .expand-btn {
    display: block;
}

/* Hover Effects */
.qr-container:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
}

/* Animation for minimize/expand */
@keyframes minimize {
    from {
        width: 200px;
        opacity: 1;
    }
    to {
        width: 50px;
        opacity: 0.8;
    }
}

@keyframes expand {
    from {
        width: 50px;
        opacity: 0.8;
    }
    to {
        width: 200px;
        opacity: 1;
    }
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    .qr-container {
        bottom: 20px;
        left: 20px;
        width: 180px;
    }

    .qr-container.minimized {
        width: 40px;
        height: 40px;
    }
}

}
    </style>
</head>
<body>

<div class="loader-container" id="loader">
    <div id="particles-js"></div>
    <div id="globe-container"></div>
    <div class="container">
        <h1 class="title"></h1>
        <p class="subtitle">Preparedness and Risk Insights with Smart Mapping</p>
        <div class="loading-bar">
            <div class="progress"></div>
        </div>
        <p class="loading-text">LOADING...</p>
    </div>
    <audio id="typeSound" preload="auto">
        <source src="https://www.soundjay.com/mechanical/sounds/typewriter-key-1.mp3" type="audio/mpeg">
    </audio>
 </div>
<!-- Replace your existing filter panel HTML with this -->
<div id="filter-container" class="filter-panel custom-filter-v1">
  <div class="filter-header-v1">
    <h3>Select Water Type</h3>
  </div>

  <div class="filter-content-v1">
    <div class="filter-item-v1">
      <input type="checkbox" id="river-check" value="river" checked>
      <label for="river-check">
        <span class="filter-label-content-v1">
          <span class="filter-icon-v1">🌊</span>
          River
        </span>
        <span class="checkbox-custom-v1"></span>
      </label>
    </div>

    <div class="filter-item-v1">
      <input type="checkbox" id="stream-check" value="stream">
      <label for="stream-check">
        <span class="filter-label-content-v1">
          <span class="filter-icon-v1">💧</span>
          Stream
        </span>
        <span class="checkbox-custom-v1"></span>
      </label>
    </div>

    <div class="filter-item-v1">
      <input type="checkbox" id="canal-check" value="canal">
      <label for="canal-check">
        <span class="filter-label-content-v1">
          <span class="filter-icon-v1">⛵</span>
          Canal
        </span>
        <span class="checkbox-custom-v1"></span>
      </label>
    </div>

    <div class="filter-item-v1">
      <input type="checkbox" id="drain-check" value="drain">
      <label for="drain-check">
        <span class="filter-label-content-v1">
          <span class="filter-icon-v1">🚰</span>
          Drain
        </span>
        <span class="checkbox-custom-v1"></span>
      </label>
    </div>

    <div class="filter-item-v1">
      <input type="checkbox" id="ditch-check" value="ditch">
      <label for="ditch-check">
        <span class="filter-label-content-v1">
          <span class="filter-icon-v1">➰</span>
          Ditch
        </span>
        <span class="checkbox-custom-v1"></span>
      </label>
    </div>

    <div class="filter-item-v1">
      <input type="checkbox" id="other-check" value="other">
      <label for="other-check">
        <span class="filter-label-content-v1">
          <span class="filter-icon-v1">❔</span>
          Other
        </span>
        <span class="checkbox-custom-v1"></span>
      </label>
    </div>
  </div>
</div>

    <div id="map"></div>
<div class="qr-panel glass-effect">
  <div class="qr-header">
    <h3>
      <svg width="18" height="18" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
        <rect x="3" y="3" width="18" height="18" rx="2"/>
        <path d="M7 7h4v4H7zM13 7h4v4h-4zM7 13h4v4H7z"/>
      </svg>
      Quick Register
    </h3>
    <button class="toggle-button" aria-label="Toggle QR panel">
      <svg width="18" height="18" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
        <path d="M5 15l7-7 7 7"/>
      </svg>
    </button>
  </div>

  <div class="qr-content panel-content">
    <div class="qr-image-container">
      <div class="qr-image-wrapper">
        <div class="scan-effect"></div>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 33 33" shape-rendering="crispEdges"><path fill="#ffffff" d="M0 0h33v33H0z"/><path stroke="#000000" d="M0 0.5h7m2 0h1m1 0h9m3 0h2m1 0h7M0 1.5h1m5 0h1m3 0h1m1 0h3m2 0h1m4 0h1m3 0h1m5 0h1M0 2.5h1m1 0h3m1 0h1m1 0h1m1 0h4m1 0h4m4 0h1m2 0h1m1 0h3m1 0h1M0 3.5h1m1 0h3m1 0h1m1 0h1m1 0h2m2 0h3m2 0h6m1 0h1m1 0h3m1 0h1M0 4.5h1m1 0h3m1 0h1m1 0h1m2 0h3m1 0h1m1 0h2m5 0h1m1 0h1m1 0h3m1 0h1M0 5.5h1m5 0h1m1 0h2m3 0h4m3 0h1m3 0h1m1 0h1m5 0h1M0 6.5h7m1 0h1m1 0h1m1 0h1m1 0h1m1 0h1m1 0h1m1 0h1m1 0h1m1 0h1m1 0h7M8 7.5h2m1 0h1m1 0h1m1 0h1m2 0h1m2 0h2m1 0h1M0 8.5h1m1 0h5m2 0h2m1 0h1m1 0h4m3 0h1m1 0h2m1 0h5M1 9.5h2m4 0h1m2 0h1m1 0h1m1 0h3m3 0h7m2 0h2m1 0h1M0 10.5h2m2 0h6m8 0h2m1 0h1m4 0h1m1 0h1m1 0h2M0 11.5h1m2 0h1m1 0h1m1 0h3m1 0h1m2 0h1m4 0h1m1 0h2m3 0h1m1 0h3m1 0h1M1 12.5h1m2 0h1m1 0h2m4 0h1m5 0h2m1 0h1m3 0h1m1 0h1m1 0h1m2 0h1M0 13.5h1m1 0h1m2 0h1m2 0h1m2 0h1m1 0h5m2 0h3m2 0h1m2 0h5M2 14.5h2m2 0h5m2 0h1m3 0h1m1 0h1m1 0h1m1 0h3m1 0h1m2 0h2M2 15.5h4m2 0h1m4 0h1m2 0h6m2 0h3m1 0h3M0 16.5h2m1 0h1m2 0h2m1 0h1m2 0h1m3 0h2m1 0h1m3 0h3m1 0h2m3 0h1M1 17.5h1m1 0h1m3 0h1m8 0h3m1 0h1m2 0h1m2 0h2m1 0h2M0 18.5h4m2 0h1m3 0h1m1 0h2m1 0h1m1 0h1m4 0h1m3 0h1m1 0h1m1 0h2M0 19.5h1m1 0h1m4 0h2m5 0h2m1 0h2m7 0h1m1 0h3M0 20.5h3m3 0h1m3 0h1m2 0h2m1 0h1m2 0h5m1 0h2m2 0h1m1 0h2M0 21.5h4m3 0h2m5 0h2m1 0h2m9 0h1m1 0h1m1 0h1M0 22.5h1m2 0h1m2 0h1m2 0h1m2 0h2m1 0h2m1 0h1m1 0h5m2 0h2m1 0h2M0 23.5h1m1 0h3m3 0h1m1 0h1m1 0h2m1 0h1m1 0h2m4 0h3m1 0h1m1 0h1m2 0h1M0 24.5h1m1 0h1m1 0h5m3 0h1m1 0h2m4 0h2m1 0h10M8 25.5h1m1 0h1m1 0h1m3 0h1m1 0h1m2 0h1m2 0h1m3 0h1m1 0h2M0 26.5h7m3 0h1m2 0h1m4 0h1m2 0h1m1 0h2m1 0h1m1 0h1m1 0h3M0 27.5h1m5 0h1m1 0h2m3 0h3m3 0h1m1 0h4m3 0h1m1 0h1m1 0h1M0 28.5h1m1 0h3m1 0h1m1 0h1m3 0h4m2 0h2m1 0h1m2 0h6M0 29.5h1m1 0h3m1 0h1m1 0h4m1 0h1m1 0h3m2 0h1m1 0h1m4 0h2M0 30.5h1m1 0h3m1 0h1m1 0h1m1 0h5m2 0h3m1 0h3m2 0h2M0 31.5h1m5 0h1m2 0h1m1 0h1m1 0h2m1 0h5m1 0h1m1 0h2m1 0h3M0 32.5h7m1 0h1m5 0h1m1 0h2m1 0h1m1 0h1m1 0h1m3 0h5"/></svg>

      </div>
    </div>

    <div class="qr-benefits">
      <h4>Get Instant Access</h4>
      <ul>
        <li>
          <span class="benefit-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
              <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5"/>
            </svg>
          </span>
          Real-time flood alerts
        </li>
        <li>
          <span class="benefit-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
              <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
          </span>
          Risk assessment
        </li>
        <li>
          <span class="benefit-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
            </svg>
          </span>
          Emergency alerts
        </li>
      </ul>
    </div>
  </div>
</div>

<style>
:root {
  --primary-color: #0891b2;
  --primary-light: #22d3ee;
  --secondary-color: #0e7490;
  --text-primary: #0f172a;
  --text-secondary: #475569;
  --background-light: #f8fafc;
  --white: #ffffff;
  --border-radius: 12px;
  --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.1);
  --shadow-md: 0 2px 4px rgba(0,0,0,0.1);
}
/* Add these styles to your CSS file */
.custom-filter-v1 {
  width: 320px;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(12px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.filter-header-v1 {
  padding-bottom: 16px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.filter-header-v1 h3 {
  color: rgba(0, 0, 0, 0.9);
  font-size: 1.25rem;
  font-weight: 600;
  margin: 0;
}

.filter-content-v1 {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.filter-item-v1 {
  position: relative;
}

.filter-item-v1 input[type="checkbox"] {
  position: absolute;
  opacity: 0;
  cursor: pointer;
  height: 0;
  width: 0;
}

.filter-item-v1 label {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: rgba(0, 0, 0, 0.05);
  border: 2px solid transparent;
  border-radius: 12px;
  color: rgba(0, 0, 0, 0.8);
  cursor: pointer;
  transition: all 0.2s ease;
}

.filter-item-v1:hover label {
  background: rgba(0, 0, 0, 0.1);
}

.filter-item-v1 input[type="checkbox"]:checked + label {
  background: rgba(59, 130, 246, 0.1);
  border-color: rgba(59, 130, 246, 0.5);
  color: rgba(0, 0, 0, 0.9);
}

.checkbox-custom-v1 {
  width: 20px;
  height: 20px;
  border: 2px solid rgba(0, 0, 0, 0.3);
  border-radius: 6px;
  position: relative;
  transition: all 0.2s ease;
}

.filter-item-v1:hover .checkbox-custom-v1 {
  border-color: rgba(0, 0, 0, 0.5);
}

.filter-item-v1 input[type="checkbox"]:checked + label .checkbox-custom-v1 {
  background: #3b82f6;
  border-color: #3b82f6;
}

.checkbox-custom-v1::after {
  content: '✓';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-size: 12px;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.filter-item-v1 input[type="checkbox"]:checked + label .checkbox-custom-v1::after {
  opacity: 1;
}

.filter-icon-v1 {
  margin-right: 12px;
  font-size: 1.2em;
}

.filter-label-content-v1 {
  display: flex;
  align-items: center;
}

.clear-button-v1 {
  width: 100%;
  padding: 12px;
  margin-top: 20px;
  background: transparent;
  border: none;
  border-radius: 8px;
  color: rgba(0, 0, 0, 0.6);
  cursor: pointer;
  transition: all 0.2s ease;
}

.clear-button-v1:hover {
  background: rgba(0, 0, 0, 0.1);
  color: rgba(0, 0, 0, 0.9);
}

/* Improved Glass Effect */
.glass-effect {
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(8px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow:
    0 4px 6px -1px rgba(0, 0, 0, 0.1),
    0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

/* Enhanced QR Section */
.qr-panel {
  position: fixed;
  left: 16px;
  bottom: 16px;
  width: 280px;
  border-radius: var(--border-radius);
  overflow: hidden;
  z-index: 1000;
  transition: var(--transition);
}

.qr-header {
  padding: 12px 16px;
  background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
  color: var(--white);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.qr-header h3 {
  margin: 0;
  font-size: 0.95rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.qr-content {
  padding: 16px;
  background: white;
}

.qr-image-container {
  background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
  padding: 16px;
  border-radius: 12px;
  margin-bottom: 16px;
}

.qr-image-wrapper {
  width: 180px;
  height: 180px;
  margin: 0 auto;
  background: white;
  border-radius: 10px;
  padding: 12px;
  box-shadow:
    0 4px 6px -1px rgba(0, 0, 0, 0.1),
    0 2px 4px -1px rgba(0, 0, 0, 0.06);
  position: relative;
  overflow: hidden;
}

.scan-effect {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 2px;
  background: linear-gradient(90deg,
    transparent,
    var(--primary-light),
    transparent
  );
  animation: scanLine 2s linear infinite;
}

@keyframes scanLine {
  0% {
    top: 0;
    opacity: 0;
  }
  10% {
    opacity: 1;
  }
  90% {
    opacity: 1;
  }
  100% {
    top: 100%;
    opacity: 0;
  }
}

.qr-benefits {
  background: var(--background-light);
  border-radius: 10px;
  padding: 14px;
}

.qr-benefits h4 {
  color: var(--text-primary);
  font-size: 0.9rem;
  margin: 0 0 12px;
}

.qr-benefits ul {
  margin: 0;
  padding: 0;
  list-style: none;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.qr-benefits li {
  display: flex;
  align-items: center;
  gap: 10px;
  color: var(--text-secondary);
  font-size: 0.85rem;
}
.benefit-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  background: rgba(8, 145, 178, 0.1);
  border-radius: 6px;
  color: var(--primary-color);
}

/* Toggle Buttons Enhancement */
.toggle-button {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  padding: 6px;
  cursor: pointer;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
}

.alert-banner {
            background: #fff5f5;
            border: 2px solid #fc8181;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .alert-title {
            color: #e53e3e;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .risk-score {
            background: white;
            color: #e53e3e;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 14px;
        }

        .alert-date {
            color: #4a5568;
            font-size: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card.blue { background: #ebf8ff; }
        .stat-card.orange { background: #fffaf0; }
        .stat-card.green { background: #f0fff4; }
        .stat-card.purple { background: #faf5ff; }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 20px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #edf2f7;
        }

        .risk-factors {
            list-style-type: none;
        }

        .risk-factors li {
            margin-bottom: 12px;
            padding-left: 20px;
            position: relative;
        }

        .risk-factors li::before {
            content: "•";
            color: #e53e3e;
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        .alert-actions {
            background: #fff;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .send-alert-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 auto;
        }

        .send-alert-btn:hover {
            background: #c53030;
        }

        .send-alert-btn:active {
            transform: translateY(1px);
        }

        .alert-disclaimer {
            color: #718096;
            font-size: 14px;
            margin-top: 12px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .concerns-list {
            display: grid;
            gap: 20px;
        }

        .concern-item h3 {
            color: #2d3748;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .timeline-section {
            margin-bottom: 24px;
        }

        .timeline-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timeline-items {
            list-style-type: none;
            padding-left: 24px;
        }

        .timeline-items li {
            margin-bottom: 8px;
            position: relative;
        }

        .timeline-items li::before {
            content: "•";
            color: #4299e1;
            position: absolute;
            left: -20px;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .alert-title {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

.toggle-button:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* Responsive Improvements */
@media (max-width: 768px) {
  .qr-panel {
    width: calc(100% - 32px);
    left: 16px;
    bottom: 80px;
  }
}

/* Panel Collapse Animation */
.collapsed {
  transform: translateY(calc(100% - 48px));
}

.collapsed .panel-content {
  display: none;
}

</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
  const filterContainer = document.querySelector('.custom-filter-v1');
  const checkboxes = filterContainer.querySelectorAll('input[type="checkbox"]');
  const counter = filterContainer.querySelector('.filter-counter-v1');
  const clearButton = filterContainer.querySelector('.clear-button-v1');

  function updateCounter() {
    const checked = filterContainer.querySelectorAll('input[type="checkbox"]:checked').length;
    counter.textContent = `${checked} selected`;
  }

  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateCounter);
  });

  clearButton.addEventListener('click', () => {
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
    updateCounter();
  });

  // Initialize counter
  updateCounter();
});
  document.querySelector('.toggle-button').addEventListener('click', function() {
    const card = document.querySelector('.qr-panel');
    card.classList.toggle('collapsed');
    const svg = this.querySelector('svg');
    svg.classList.toggle('rotated');
  });

  document.addEventListener('DOMContentLoaded', function() {
    const svg = document.querySelector('.toggle-button svg');
    svg.classList.add('rotated');
  });
</script>

<style>
/* Rotate arrow when panel is collapsed */
.rotated {
  transform: rotate(180deg);
  transition: transform 0.2s ease;
}
</style>

<div id="control-panel">
    <div class="button-group">
        <button id="analysisButton" class="control-button">
            <span class="button-text">📊 Start Analysis</span>
        </button>
        <button id="inundationButton" class="control-button">
            <span class="button-text">💧 Show Flood Zones</span>
        </button>
    </div>
</div>


    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>

    <script>
    class Globe {
    constructor() {
        this.width = 600;
        this.height = 600;
        this.rotation = 0;
        
        // Use createElementNS for SVG
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("width", this.width);
        svg.setAttribute("height", this.height);
        document.getElementById('globe-container').appendChild(svg);
        
        this.svg = d3.select(svg);
        
        // Memoize projection
        this.projection = d3.geoOrthographic()
            .scale(250)
            .center([0, 0])
            .rotate([0, 0])
            .translate([this.width / 2, this.height / 2]);
        
        this.path = d3.geoPath().projection(this.projection);
        
        // Use async/await for data loading
        this.loadWorldData();
    }
    
    async loadWorldData() {
        try {
            const data = await d3.json('https://unpkg.com/world-atlas@2.0.2/countries-110m.json');
            this.worldData = data;
            this.countries = topojson.feature(data, data.objects.countries);
            this.render();
            this.animate();
        } catch (error) {
            console.error('Failed to load world data:', error);
        }
    }
    
    render() {
        // Create elements once and update attributes
        const paths = this.svg.selectAll('path')
            .data(this.countries.features);
            
        paths.enter()
            .append('path')
            .merge(paths)
            .attr('d', this.path)
            .style('fill', '#aaa')
            .style('stroke', '#ddd')
            .style('stroke-width', '0.5');
            
        paths.exit().remove();
    }
    
    animate() {
        if (!this.animationFrame) {
            const animate = () => {
                this.rotation = (this.rotation + 0.5) % 360;
                this.projection.rotate([this.rotation, 0]);
                this.svg.selectAll('path').attr('d', this.path);
                this.animationFrame = requestAnimationFrame(animate);
            };
            animate();
        }
    }

    destroy() {
        if (this.animationFrame) {
            cancelAnimationFrame(this.animationFrame);
            this.animationFrame = null;
        }
    }
}
        // Performance optimization: Use RequestAnimationFrame for animations
        const animateTitle = () => {
    const particlesConfig = {
        particles: {
            number: { value: 50 }, // Reduced particle count
            color: { value: '#808080' },
            shape: { type: 'circle' },
            opacity: {
                value: 0.5,
                random: true
            },
            size: {
                value: 3,
                random: true
            },
            line_linked: {
                enable: true,
                distance: 150,
                color: '#808080',
                opacity: 0.2,
                width: 1
            },
            move: {
                enable: true,
                speed: 2,
                direction: 'none',
                random: true,
                straight: false,
                out_mode: 'out'
            }
        }
    };

    particlesJS('particles-js', particlesConfig);

    const title = document.querySelector('.title');
    const text = 'P.R.I.S.M.';
    const typeSound = document.getElementById('typeSound');
    let index = 0;

    const playTypeSound = () => {
        const sound = typeSound.cloneNode();
        sound.volume = 0.2;
        sound.play().catch(() => {});
    };

    // Use DocumentFragment for better performance
    const fragment = document.createDocumentFragment();
    const spans = text.split('').map(char => {
        const span = document.createElement('span');
        span.textContent = char;
        span.style.opacity = '0';
        return span;
    });
    
    spans.forEach(span => fragment.appendChild(span));
    title.appendChild(fragment);

    const typeWriter = () => {
        if (index < spans.length) {
            spans[index].style.opacity = '1';
            playTypeSound();
            index++;
            setTimeout(typeWriter, 200);
        }
    };

    // Start typing after DOM is ready
    requestAnimationFrame(typeWriter);

    // Optimize cursor trail
    let cursorTimeout;
    const cursorTrails = [];
    
    document.addEventListener('mousemove', (e) => {
        if (cursorTimeout) return;
        
        cursorTimeout = setTimeout(() => {
            cursorTimeout = null;
        }, 50);

        const cursor = document.createElement('div');
        cursor.className = 'cursor-trail';
        cursor.style.left = e.pageX + 'px';
        cursor.style.top = e.pageY + 'px';
        document.body.appendChild(cursor);
        
        cursorTrails.push(cursor);
        if (cursorTrails.length > 5) {
            const oldCursor = cursorTrails.shift();
            oldCursor.remove();
        }

        setTimeout(() => {
            cursor.remove();
            const index = cursorTrails.indexOf(cursor);
            if (index > -1) cursorTrails.splice(index, 1);
        }, 1000);
    }, { passive: true });
};


        class MapApplication {
            constructor() {
                this.map = null;
                this.loader = document.getElementById('loader');
                this.isAnalysisMode = false;
                this.activeRipples = [];
                this.initialize();
            }

            initialize() {
                new Globe();
                this.initializeMap();
                this.loadShapefile();
                this.initializeAnalysisButton();
                this.setupFilterListeners();
                this.initializeInundationButton();

            }

            initializeMap() {
                this.map = L.map('map').setView([45.9432, 24.9668], 6);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.map);
            }
            
            setupFilterListeners() {
                const waterTypes = ['river', 'stream', 'canal', 'drain', 'other', 'ditch'];
                waterTypes.forEach(type => {
                    document.getElementById(`${type}-check`).addEventListener('change', () => {
                        this.filterWaterways();
                    });
                });
            }
        
            initializeAnalysisButton() {
                const button = document.getElementById('analysisButton');
                button.addEventListener('click', () => {
                    this.isAnalysisMode = !this.isAnalysisMode;
                    button.classList.toggle('active');
                    button.textContent = this.isAnalysisMode ? '📊 Cancel Analysis' : '📊 Start Analysis';
                    
                    if (this.isAnalysisMode) {
                        this.map.on('click', this.handleMapClick.bind(this));
                    } else {
                        this.map.off('click');
                        this.clearRipples();
                    }
                });
            }
            
            destroy() {
                this.map.remove();
                if (this.globe) {
                    this.globe.destroy();
                }
                this.clearRipples();
            }

            async loadShapefile() {
                try {
                    const response = await fetch('/shapefile/waterways_romania.zip');
                    if (!response.ok) throw new Error('Failed to fetch shapefile');

                    const arrayBuffer = await response.arrayBuffer();
                    const geojsonArray = await shp.parseZip(arrayBuffer);
                    await this.processGeoJSON(geojsonArray);
                    
                    this.fadeOutLoader();
                } catch (error) {
                    console.error('Error loading shapefile:', error);
                    document.querySelector('.loading-text').textContent = 'Error loading data';
                }
            }

            fadeOutLoader() {
                animateTitle();
                setTimeout(() => this.loader.remove(), 6000);
            }

            async processGeoJSON(geojsonArray) {
            const data = Array.isArray(geojsonArray) ? geojsonArray[0] : geojsonArray;
            if (!data || !data.features) throw new Error('Invalid GeoJSON data');
            
            // Color mapping for different water types
            const waterTypeColors = {
                'river': '#3388ff',
                'stream': '#2ecc71', 
                'canal': '#e74c3c',
                'drain': '#f39c12',
                'other': '#9b59b6',
                'ditch': '#34495e'
            };

            this.waterLayer = L.geoJSON(data, {
                style: (feature) => {
                    const waterType = feature.properties.waterway || 'other';
                    return {
                        color: waterTypeColors[waterType] || '#34495e',
                        weight: 3,
                        opacity: 0.7
                    };
                }
            }).addTo(this.map);

            this.filterWaterways();
        }

        initializeInundationButton() {
            const button = document.getElementById('inundationButton');
            button.addEventListener('click', () => this.handleInundationToggle());

        }

        async handleInundationToggle() {
    const button = document.getElementById('inundationButton');

    if (this.inundationLayer) {
        // Enhanced fade-out with wave effect
        this.inundationLayer.eachLayer(layer => {
            layer.getElement()?.classList.add('wave-fade-out');
        });

        setTimeout(() => {
            this.map.removeLayer(this.inundationLayer);
            this.inundationLayer = null;
            if (this.legend) {
                this.map.removeControl(this.legend);
                this.legend = null;
            }
            if (this.warningOverlay) {
                this.map.removeLayer(this.warningOverlay);
                this.warningOverlay = null;
            }
        }, 800);

        button.textContent = '💧Load Flood Zones';
        button.classList.remove('active');
        this.filterWaterways();
    } else {
        try {
            button.textContent = '💧 Loading...';
            button.disabled = true;
            debugger
            const response = await fetch('/shapefile/Archive.zip');
            if (!response.ok) throw new Error('Failed to fetch inundation shapefile');

            const arrayBuffer = await response.arrayBuffer();
            const geojsonArray = await shp.parseZip(arrayBuffer);

            const sendAlertNotification = async () => {
            try {
                // Show loading state
                const alertButton = document.querySelector('.send-alert-btn');
                if (alertButton) {
                    alertButton.disabled = true;
                    alertButton.innerHTML = '📤 Sending...';
                }

                const response = await fetch('/api/send-flood-alert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        // Your alert data here
                        alertLevel: 'High',
                        timestamp: new Date().toISOString(),
                        // Add other relevant data
                    })
                });

                if (!response.ok) throw new Error('Failed to send alert');

                // Show success notification using a custom modal
                const modal = document.createElement('div');
                modal.className = 'alert-modal';
                modal.innerHTML = `
                    <div class="alert-modal-content">
                        <div class="alert-modal-header">
                            <span class="alert-modal-icon">✅</span>
                            <h3>Alert Sent Successfully</h3>
                        </div>
                        <p>The flood risk alert has been sent to all registered recipients.</p>
                        <button class="alert-modal-close-btn">Close</button>
                    </div>
                `;
                document.body.appendChild(modal);

                // Add modal styles
                const style = document.createElement('style');
                style.textContent = `
                    .alert-modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 1000;
                    }
                    .alert-modal-content {
                        background: white;
                        padding: 20px;
                        border-radius: 8px;
                        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                        max-width: 400px;
                        width: 90%;
                        text-align: center;
                    }
                    .alert-modal-header {
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 10px;
                        margin-bottom: 15px;
                    }
                    .alert-modal-icon {
                        font-size: 24px;
                    }
                    .alert-modal-close-btn {
                        margin-top: 15px;
                        padding: 8px 16px;
                        background: #007bff;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        transition: background 0.2s;
                    }
                    .alert-modal-close-btn:hover {
                        background: #0056b3;
                    }
                `;
                document.head.appendChild(style);

                // Handle modal close
                const closeBtn = modal.querySelector('.alert-modal-close-btn');
                closeBtn.onclick = () => {
                    modal.remove();
                    style.remove();
                };

                // Reset button state
                if (alertButton) {
                    alertButton.disabled = false;
                    alertButton.innerHTML = '🚨Send Emergency Alert';
                }

            } catch (error) {
                console.error('Error sending alert:', error);
                // Show error notification
                alert('Failed to send alert. Please try again.');

                // Reset button state
                const alertButton = document.querySelector('.send-alert-btn');
                if (alertButton) {
                    alertButton.disabled = false;
                    alertButton.innerHTML = '🚨Send Emergency Alert';
                }
            }
        };

            // Enhanced styling with danger indicators
            const getFloodZoneStyle = (feature) => {
                const riskLevel = feature.properties.risk_level?.toLowerCase() || 'high';
                const depth = feature.properties.depth || 1;

                const getColorConfig = () => {
                    switch(riskLevel) {
                        case 'high':
                            return {
                                fill: '#ff1744',
                                border: '#d50000',
                                pulseColor: 'rgba(255, 23, 68, 0.6)'
                            };
                        case 'medium':
                            return {
                                fill: '#ff9100',
                                border: '#f57c00',
                                pulseColor: 'rgba(255, 145, 0, 0.5)'
                            };
                        case 'low':
                            return {
                                fill: '#ffeb3b',
                                border: '#fdd835',
                                pulseColor: 'rgba(255, 235, 59, 0.4)'
                            };
                        default:
                            return {
                                fill: '#90caf9',
                                border: '#64b5f6',
                                pulseColor: 'rgba(144, 202, 249, 0.3)'
                            };
                    }
                };

                const colors = getColorConfig();
                return {
                    fillColor: colors.fill,
                    color: colors.border,
                    weight: 3,
                    opacity: 0.9,
                    fillOpacity: 0.4 + (depth * 0.15),
                    className: `flood-zone flood-zone-${riskLevel} danger-zone`,
                };
            };

            // Create and add the inundation layer with enhanced animations
            this.inundationLayer = L.geoJSON(geojsonArray, {
                style: getFloodZoneStyle,
                onEachFeature: (feature, layer) => {
                    // Add dramatic entrance animation
                    layer.on('add', () => {
                        setTimeout(() => {
                            const el = layer.getElement();
                            if (el) {
                                el.classList.add('flood-zone-appear');
                                // Add danger indicators for high-risk zones
                                if (feature.properties.risk_level?.toLowerCase() === 'high') {
                                    el.innerHTML += '<div class="danger-indicator"></div>';
                                    el.innerHTML += '<div class="warning-pulse"></div>';
                                }
                            }
                        }, Math.random() * 800);
                    });

                    layer.on({
                        mouseover: (e) => {
                            const layer = e.target;
                            const riskLevel = feature.properties.risk_level?.toLowerCase() || 'medium';

                            layer.setStyle({
                                weight: 4,
                                opacity: 1,
                                fillOpacity: 0.85,
                            });

                            layer.getElement()?.classList.add('flood-zone-hover');
                            layer.bringToFront();

                            // Enhanced ripple effect
                            const el = layer.getElement();
                            if (el) {
                                el.innerHTML += '<div class="ripple-danger"></div>';
                                if (riskLevel === 'high') {
                                    el.innerHTML += '<div class="danger-flash"></div>';
                                }
                                setTimeout(() => {
                                    const ripple = el.querySelector('.ripple-danger');
                                    const flash = el.querySelector('.danger-flash');
                                    if (ripple) ripple.remove();
                                    if (flash) flash.remove();
                                }, 1500);
                            }
                        },
                        mouseout: (e) => {
                            const layer = e.target;
                            this.inundationLayer.resetStyle(e.target);
                            layer.getElement()?.classList.remove('flood-zone-hover');
                        },
                        click: async (e) => {
                        this.createRippleEffect(e.latlng);

                        const loadingOverlay = this.createLoadingOverlay(e.latlng);
                        try {


                        // Simulate data loading
                        await new Promise(resolve => setTimeout(resolve, 5000));

                        // Remove loading overlay and ripples
                        loadingOverlay.remove();
                        this.clearRipples();


                        const data = {
                            riskLevel: 'High',
                            riskScore: '8.5/10',
                            statistics: {
                                buildings_in_area: 156,
                                transportation_features: 23,
                                landuse_areas: 12,
                                known_inundation_areas: 3
                            },
                            mainFactors: [
                                'Located within 100m of River Thames flood plain with historical overflow patterns',
                                'Area elevation is 2.5m below surrounding regions, creating natural water collection point',
                                'Aging drainage infrastructure (>30 years old) with limited capacity during peak flows',
                                'Soil composition shows 65% clay content, reducing natural drainage capacity',
                                'Urban development has reduced natural permeable surfaces by 40% over past decade',
                                'Three major flood incidents recorded in the past 5 years (2019, 2021, 2023)',
                                'Current flood defense structures rated as "requiring significant improvement"'
                            ],
                            weather: {
                                temperature: 22,
                                precipitation: 45,
                                wind_speed: 15,
                                condition: 'Heavy Rain'
                            },
                            concerns: [
                                'Critical infrastructure vulnerability: Main power substation serving 50,000 households located in potential flood zone',
                                'Emergency access routes: Both primary evacuation roads have history of flooding at depths >30cm',
                                'Public safety: 3 schools and 1 care home within high-risk area require priority evacuation planning',
                                'Economic impact: Business district with annual revenue >£10M at risk of operational disruption',
                                'Environmental hazards: 2 fuel storage facilities in area pose contamination risk if flooded',
                                'Historical sites: Grade II listed buildings require specialized flood protection measures',
                                'Social vulnerability: 25% of residents are elderly or mobility-impaired requiring additional assistance'
                            ],
                            explanation: [
                                'This area faces compound flood risks due to its topographical position and infrastructure conditions. The combination of riverine and surface water flooding presents a significant threat, particularly during high-rainfall seasons.',
                                'Historical data shows increasing flood frequency, with events becoming more severe. The area\'s drainage system, designed in the 1980s, cannot cope with current precipitation patterns.',
                                'Recent urban development has exacerbated the situation by reducing natural drainage capacity. Climate change projections indicate a 40% increase in extreme rainfall events by 2050.',
                                'The presence of critical infrastructure and vulnerable populations makes this area a priority for flood management interventions. Economic analyses suggest potential losses of £25M+ in a major flood event.'
                            ].join(' '),
                            recommendations: [
                                'Immediate Actions (0-6 months):\n' +
                                '- Install automated flood warning systems at key monitoring points\n' +
                                '- Conduct emergency response drills with local community\n' +
                                '- Clear and maintain all drainage systems monthly',

                                'Short-term Measures (6-12 months):\n' +
                                '- Upgrade pump station capacity by 50%\n' +
                                '- Install temporary flood barriers around critical infrastructure\n' +
                                '- Develop detailed evacuation plans for vulnerable residents',

                                'Medium-term Solutions (1-3 years):\n' +
                                '- Implement sustainable drainage systems (SuDS)\n' +
                                '- Create upstream water storage areas\n' +
                                '- Retrofit buildings with flood resilience measures',

                                'Long-term Strategy (3-5 years):\n' +
                                '- Develop new flood defense infrastructure\n' +
                                '- Restore natural floodplains\n' +
                                '- Implement stricter building regulations for new developments'
                            ]
                        };

                        const popupContent = `
                            <div class="popup-content">
                                <div class="alert-banner">
            <div class="alert-title">
                🚨FLOOD RISK ALERT
                <span class="risk-score">Risk Score: 8.5/10</span>
            </div>
            <div class="alert-date">
                Predicted Flood Event Window: February 8-10, 2025
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card blue">
                <div class="stat-number">156</div>
                <div>Buildings in High-Risk Zones</div>
            </div>
            <div class="stat-card orange">
                <div class="stat-number">23</div>
                <div>Critical Transport Features</div>
            </div>
            <div class="stat-card green">
                <div class="stat-number">12</div>
                <div>Land Use Areas at Risk</div>
            </div>
            <div class="stat-card purple">
                <div class="stat-number">3</div>
                <div>Active Flood Zones</div>
            </div>
        </div>

        <!-- Risk Factors -->
        <div class="card">
            <h2 class="card-title">Key Risk Factors & Contributing Conditions</h2>
            <ul class="risk-factors">
                <li>Proximity to River Thames floodplain (within 100m), exhibiting historical overflow patterns</li>
                <li>Area elevation is 2.5m below surrounding regions, forming a natural water collection basin</li>
                <li>Aging drainage infrastructure (over 30 years old) with limited capacity during projected peak flows</li>
                <li>Soil composition contains 65% clay, severely limiting natural water absorption</li>
                <li>Urban development has reduced natural permeable surfaces by 40% in the last decade, escalating runoff risks</li>
                <li>Three significant flood incidents recorded in 2019, 2021, and 2023, signaling increasing event frequency</li>
                <li>Current flood defense structures are rated as requiring significant improvement to handle future conditions</li>
            </ul>
        </div>

        <!-- Immediate Concerns -->
        <div class="card">
            <h2 class="card-title">Immediate Concerns & Infrastructure Vulnerabilities</h2>
            <div class="concerns-list">
                <div class="concern-item">
                    <h3>Critical Infrastructure Risk</h3>
                    <p>The main power substation serving 50,000 households is located in a potential flood zone</p>
                </div>
                <div class="concern-item">
                    <h3>Evacuation Route Threats</h3>
                    <p>Both primary emergency access roads have historically flooded to depths exceeding 30cm, potentially impeding rescue operations</p>
                </div>
                <div class="concern-item">
                    <h3>Public Safety Concerns</h3>
                    <p>3 schools and 1 care home lie within the high-risk area, requiring priority evacuation planning</p>
                </div>
                <div class="concern-item">
                    <h3>Economic Impact</h3>
                    <p>A business district generating £10M+ in annual revenue is at risk of significant operational disruption</p>
                </div>
                <div class="concern-item">
                    <h3>Environmental Hazards</h3>
                    <p>2 fuel storage facilities in the area pose a contamination risk if inundated</p>
                </div>
                <div class="concern-item">
                    <h3>Cultural Heritage Risk</h3>
                    <p>Several Grade II listed buildings necessitate specialized flood protection measures</p>
                </div>
                <div class="concern-item">
                    <h3>Social Vulnerability</h3>
                    <p>Approximately 25% of residents are elderly or mobility-impaired, necessitating additional support and tailored evacuation strategies</p>
                </div>
            </div>
        </div>

        <!-- Strategic Recommendations -->
        <div class="card">
            <h2 class="card-title">Strategic Recommendations</h2>

            <div class="timeline-section">
                <h3 class="timeline-title">⚡ Immediate Actions (0-6 Months)</h3>
                <ul class="timeline-items">
                    <li>Deploy automated flood warning systems at strategic monitoring points using real-time data integration</li>
                    <li>Conduct emergency response drills in collaboration with local communities to ensure preparedness</li>
                    <li>Clear and maintain drainage systems on a monthly basis to ensure optimal flow capacity</li>
                </ul>
            </div>

            <div class="timeline-section">
                <h3 class="timeline-title">🔶 Short-Term Measures (6-12 Months)</h3>
                <ul class="timeline-items">
                    <li>Upgrade pump station capacity by 50% to handle increased water volumes</li>
                    <li>Install temporary flood barriers around critical infrastructure, including the power substation and fuel storage facilities</li>
                    <li>Develop comprehensive evacuation plans focused on high-risk zones, particularly for schools, care homes, and vulnerable residents</li>
                </ul>
            </div>

            <div class="timeline-section">
                <h3 class="timeline-title">🔷 Medium-Term Solutions (1-3 Years)</h3>
                <ul class="timeline-items">
                    <li>Implement Sustainable Drainage Systems (SuDS) to manage surface water runoff</li>
                    <li>Create upstream water storage areas to mitigate downstream flooding</li>
                    <li>Retrofit buildings with flood resilience measures, focusing on critical and historical structures</li>
                </ul>
            </div>

            <div class="timeline-section">
                <h3 class="timeline-title">🌿 Long-Term Strategy (3-5 Years)</h3>
                <ul class="timeline-items">
                    <li>Develop new flood defense infrastructure, including levees and floodwalls, informed by predictive flood models</li>
                    <li>Restore natural floodplains to reintroduce natural water absorption processes</li>
                    <li>Implement stricter building regulations for new developments to mitigate future flood risks</li>
                </ul>
            </div>
        </div>

        <div class="alert-actions">
<button class="send-alert-btn" onclick="sendAlertNotification()">
    🚨 Send Emergency Alert
</button>
</div>
                            </div>
                        `;

                        // Attach the sendAlertNotification function to the window object
                        window.sendAlertNotification = sendAlertNotification;

                        layer.bindPopup(popupContent, {
                            maxWidth: 500,
                            className: 'flood-risk-popup-container'
                        }).openPopup();


                    } catch (error) {
                        console.error('Error loading data:', error);
                        loadingOverlay.remove();
                        this.clearRipples();
                    }



                    }
                    });
                }
            }).addTo(this.map);


            // Add warning overlay for high-risk zones
            const highRiskFeatures = geojsonArray.features.filter(f =>
                f.properties.risk_level?.toLowerCase() === 'high'
            );

            if (highRiskFeatures.length > 0) {
                this.warningOverlay = L.geoJSON(highRiskFeatures, {
                    style: {
                        fillColor: 'transparent',
                        weight: 2,
                        color: '#ff0000',
                        opacity: 0.8,
                        className: 'warning-boundary'
                    }
                }).addTo(this.map);
            }

            // Enhanced zoom animation
            const bounds = this.inundationLayer.getBounds();
            const paddedBounds = bounds.pad(0.15);

            this.map.flyToBounds(paddedBounds, {
                duration: 2.5,
                easeLinearity: 0.25,
                animate: true
            });

            button.textContent = '💧 Hide Flood Zones';
            button.classList.add('active');
        } catch (error) {
            console.error('Error loading inundation data:', error);
            button.textContent = '💧 Load Flood Zones';
            alert('Error loading inundation data');
        } finally {
            button.disabled = false;
        }
    }

}

createLoadingOverlay(latlng) {
    const point = this.map.latLngToContainerPoint(latlng);
    const overlay = L.DomUtil.create('div', 'loading-overlay');

    Object.assign(overlay.style, {
        left: `${point.x - 25}px`,
        top: `${point.y - 25}px`,
        width: '50px',
        height: '50px'
    });

    const spinner = L.DomUtil.create('div', 'loading-spinner');
    overlay.appendChild(spinner);

    this.map.getContainer().appendChild(overlay);
    return overlay;
}
    destroy() {
        this.map.remove();
        if (this.globe) {
            this.globe.destroy();
        }
        if (this.inundationLayer) {
            this.map.removeLayer(this.inundationLayer);
        }
        this.clearRipples();
    }


        
        filterWaterways() {
            if (!this.waterLayer) return;

            this.waterLayer.eachLayer(layer => {
                // Use 'waterway' or fallback to 'other' if not present
                const waterType = layer.feature.properties.waterway || 'other';
                const waterTypes = ['river', 'stream', 'canal', 'drain', 'other', 'ditch']
                if (waterTypes.includes(waterType)) {
    
                    const isChecked = document.getElementById(`${waterType}-check`).checked;
                    
                    
                    if (isChecked) {
                        layer.addTo(this.map);
                    } else {
                        this.map.removeLayer(layer);
                    }
                }
            });
        }

            createRippleEffect(latlng) {
                const point = this.map.latLngToContainerPoint(latlng);
                const rippleSize = 200;
                
                [0, 0.4, 0.8].forEach(delay => {
                    const ripple = L.DomUtil.create('div', 'ripple');
                    Object.assign(ripple.style, {
                        left: `${point.x - rippleSize/2}px`,
                        top: `${point.y - rippleSize/2}px`,
                        width: `${rippleSize}px`,
                        height: `${rippleSize}px`,
                        animationDelay: `${delay}s`
                    });
                    
                    this.map.getContainer().appendChild(ripple);
                    this.activeRipples.push(ripple);
                });
            }

            clearRipples() {
                this.activeRipples.forEach(ripple => ripple.remove());
                this.activeRipples = [];
            }

            createPopupContent(data) {
                return `
                    <div class="popup-content">
                        <h3 class="popup-title">Flood Risk Analysis</h3>
                        <p><strong>Risk Level:</strong> <span class="risk-level ${data.riskLevel.toLowerCase()}">${data.riskLevel}</span></p>
                        <p><strong>Risk Score:</strong> ${data.riskScore}</p>
                        
                        <h4>Main Factors</h4>
                        <ul class="popup-list">
                            ${data.mainFactors.map(factor => `<li>${factor}</li>`).join('')}
                        </ul>

                        <div class="weather-section">
                            <h4>Weather Conditions</h4>
                            <div class="weather-grid">
                                <div class="weather-item">
                                    <span>🌡️</span>
                                    <span>${data.weather.temperature}°C</span>
                                </div>
                                <div class="weather-item">
                                    <span>💧</span>
                                    <span>${data.weather.precipitation}mm</span>
                                </div>
                                <div class="weather-item">
                                    <span>💨</span>
                                    <span>${data.weather.wind_speed} km/h</span>
                                </div>
                                <div class="weather-item">
                                    <span>🌤️</span>
                                    <span>${data.weather.condition}</span>
                                </div>
                            </div>
                        </div>
                        
                        <h4>Concerns</h4>
                        <ul class="popup-list">
                            ${data.concerns.map(concern => `<li>${concern}</li>`).join('')}
                        </ul>
                        
                        <h4>Explanation</h4>
                        <ul class="popup-list">
                            <li>${data.explanation}</li>
                        </ul>
                        
                        <h4>Recommendations</h4>
                        <ul class="popup-list">
                            ${data.recommendations.map(recommendation => `<li>${recommendation}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            async handleMapClick(e) {
                if (!this.isAnalysisMode) return;
                
                this.createRippleEffect(e.latlng);

                try {
                    const response = await fetch('api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            point: {
                                lat: e.latlng.lat,
                                lng: e.latlng.lng
                            },
                            radius: 2500
                        })
                    });

                    if (!response.ok) throw new Error('API request failed');
                    const data = await response.json();

                    this.clearRipples();
                    
                    const popup = L.popup({
                        maxWidth: 400,
                        className: 'custom-popup'
                    })
                        .setLatLng(e.latlng)
                        .setContent(this.createPopupContent(data))
                        .openOn(this.map);

                } catch (error) {
                    console.error('Analysis error:', error);
                    this.clearRipples();
                    L.popup()
                        .setLatLng(e.latlng)
                        .setContent('<div class="popup-content">Error analyzing data.</div>')
                        .openOn(this.map);
                }
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', () => new MapApplication());
    </script>
</body>
</html>



